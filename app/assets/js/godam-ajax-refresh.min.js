class CommentRefreshManager{constructor(){this.refreshingComments=new Set,this.retryAttempts=new Map,this.maxRetries=3,this.godamCheckTimeout=200}waitForGODAMPlayer(e=this.godamCheckTimeout){return new Promise((t=>{const i=Date.now(),n=()=>{if("function"==typeof GODAMPlayer)try{const e=document.createElement("div");return e.innerHTML="<video></video>",document.body.appendChild(e),GODAMPlayer(e),document.body.removeChild(e),void t(!0)}catch{}Date.now()-i>e?t(!1):setTimeout(n,100)};n()}))}validateRequest(e,t){return!(!e||!t)&&(!("undefined"==typeof GodamAjax||!GodamAjax.ajax_url||!GodamAjax.nonce)&&(!!document.contains(t)&&!this.refreshingComments.has(e)))}async initializeGODAMPlayerForReply(e,t){if(!await this.waitForGODAMPlayer())return!1;const i=e.querySelectorAll("video"),n=e.querySelectorAll(".easydam-video-container");if(0===i.length&&0===n.length)return!0;e.setAttribute("data-godam-reply-processing","true");try{GODAMPlayer(e)}catch{for(const e of n)try{GODAMPlayer(e)}catch{}for(const e of i)try{const t=e.closest(".easydam-video-container")||e.parentElement;GODAMPlayer(t)}catch{}}try{GODAMPlayer()}catch{}return e.removeAttribute("data-godam-reply-processing"),e.setAttribute("data-godam-reply-initialized","true"),setTimeout((()=>{e.querySelectorAll(".animate-video-loading").forEach((e=>e.classList.remove("animate-video-loading")))}),300),!0}async handleSuccessfulResponse(e,t,i){const n=i.closest(".activity-item");if(!n)return;const a=n.id.replace("activity-","");let o=document.querySelector(`#activity-${a} .activity-comments`);o||(o=document.createElement("ul"),o.classList.add("activity-comments"),n.appendChild(o));const s=document.createElement("div");s.innerHTML=e.data.html.trim();const r=s.firstElementChild;if(!r)return;i.replaceWith(r);let c=!1;for(let e=1;e<=3&&(await new Promise((t=>setTimeout(t,100*e))),c=await this.initializeGODAMPlayerForReply(r,t),!c);e++);setTimeout((()=>{document.dispatchEvent(new CustomEvent("commentRefreshed",{detail:{commentId:t,node:r,playerReady:c,isReply:!0},bubbles:!0}))}),200)}async refreshSingleComment(e,t){if(!this.validateRequest(e,t))return;this.refreshingComments.add(e),t.classList.add("refreshing");const i=new AbortController,n=setTimeout((()=>i.abort()),15e3);try{const a=await fetch(GodamAjax.ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"get_single_activity_comment_html",comment_id:e,nonce:GodamAjax.nonce}),signal:i.signal});if(clearTimeout(n),!a.ok)throw new Error;const o=await a.json();o&&o.success&&o.data&&o.data.html?await this.handleSuccessfulResponse(o,e,t):this.scheduleRetry(e,t)}catch{clearTimeout(n),this.scheduleRetry(e,t)}finally{clearTimeout(n),this.refreshingComments.delete(e),document.contains(t)&&t.classList.remove("refreshing")}}scheduleRetry(e,t){const i=this.retryAttempts.get(e)||0;if(i>=this.maxRetries)return;const n=1e3*Math.pow(2,i);this.retryAttempts.set(e,i+1),setTimeout((()=>{document.contains(t)&&this.refreshSingleComment(e,t)}),n)}async initializeExistingComments(){const e=document.querySelectorAll('li[id^="acomment-"]');for(const t of e){const e=t.id.replace("acomment-","");await this.initializeGODAMPlayerForReply(t,e)}}initialize(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>this.setupSystem())):this.setupSystem()}async setupSystem(){await this.initializeExistingComments(),this.setupMutationObservers()}debounce(e,t){let i;return function(...n){clearTimeout(i),i=setTimeout((()=>e(...n)),t)}}setupMutationObservers(){const e=document.querySelectorAll(".activity-comments"),t=this.debounce((e=>{this.handleNewComments(e)}),200);if(0!==e.length)e.forEach((e=>{new MutationObserver(t).observe(e,{childList:!0,subtree:!0})}));else{new MutationObserver(t).observe(document.body,{childList:!0,subtree:!0})}}async handleNewComments(e){for(const t of e)for(const e of t.addedNodes)if(1===e.nodeType&&e.matches('li[id^="acomment-"]')){const t=e.id.replace("acomment-","");setTimeout((async()=>{document.contains(e)&&(await this.initializeGODAMPlayerForReply(e,t),await this.refreshSingleComment(t,e))}),200)}}}const commentRefreshManager=new CommentRefreshManager;commentRefreshManager.initialize(),window.CommentRefreshManager=commentRefreshManager;